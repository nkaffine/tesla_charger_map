<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>
<script>
    function processData() {
        let link = "https://www.projectcoups.dreamhosters.com/?";
        link += "name=" + encodeURIComponent($("#name").val()) + "&email=" + encodeURIComponent($("#email").val()) +
            "&link=" + encodeURIComponent($("#link").val()) + "&rating=" + encodeURIComponent($("#rating").val()) +
            "&type=" + encodeURIComponent($("#chargerType").val()) + "&charger_id=" + encodeURIComponent($("#chargers").val());
        $.getJSON(link, function (data) {
            if (data.error !== null) {
                $("#content").html(
                    "<div class=\"panel panel-danger\">" + "<div class=\"panel-heading\">Error:</div>" +
                    "<div class=\"panel-body\">" + data.error + "</div>" + "</div>" + $("#content").html());
            } else {
                $("#content").html(
                    "<div class=\"panel panel-success\">" + "<div class=\"panel-heading\">Success!</div>" +
                    "<div class=\"panel-body\">" + data.success + "</div>" + "</div>");
            }
        });
    }
    function handleError(error) {
        console.log(error);
    }
    function checkValidForm() {
        if ($("#name").val() === "" || $("#email").val() === "" || $("#location").val() === "" ||
            $("#address").val() === "" || $("#link").val() === "" || $("#rating") === "") {
            $("#content").html("<div class=\"panel panel-danger\">" + "<div class=\"panel-heading\">Error:</div>" +
                "<div class=\"panel-body\">Not all fields were filled out</div>" + "</div>" + $("#content").html());
            return false;
        } else {
            if (validYoutubeLink($("#link").val()))
            {
                return true;
            }
            else
            {
                $("#content").html("<div class=\"panel panel-danger\">" + "<div class=\"panel-heading\">Error:</div>" +
                    "<div class=\"panel-body\">Invalid Youtube Link</div>" + "</div>" + $("#content").html());
            }
        }
    }

    function validYoutubeLink(link)
    {
        let elements = link.split(".");
        if (elements.length === 2) {
            return true;
        } else if (elements.length === 3) {
            if (elements[2].substr(4, 5) === "watch") {
                let part = elements[2].split("=");
                return part.length === 2;
            } else {
                return true;
            }
        }
        else
        {
            return false;
        }
    }

    function searchChargers(query, chargerType)
    {
        let success = function(data) {
            if (data.error !== undefined) {
                handleError(data.error)
            }
            else
            {
                var innerHtml = "";
                data.forEach(function (charger) {
                    innerHtml += ("<option value='"+ charger.id + "'>"+charger.name+"</option>")
                });
                $("#chargers").html(innerHtml);
                $("#chargers").selectpicker('refresh');
            }
        };
        let link = "https://www.projectcoups.dreamhosters.com/new/search_charger/";
        let data = {'charger_type' : chargerType, 'query': query};
        $.ajax({
            type: "POST",
            url: link,
            data: data,
            success: success,
            dataType: "json"
        });
    }

    $(document).ready(function () {
        $("#submitButton").click(function () {
            if (checkValidForm()) {
                processData();
            } else {
                doNothing();
            }
        });
        $("#location").keypress(function(value) {
            let location = $("#location").val() + value.originalEvent.key;
            let chargerType = $("#chargerType").val();
            var newChargerType = null;
            if (chargerType == 0)
            {
                newChargerType = "super"
            }
            else if (chargerType == 1)
            {
                newChargerType = "destination"
            }
            if (location !== null && newChargerType !== null)
            {
                searchChargers(location, newChargerType);
            }
        });
    });
</script>
<div id="content" style="overflow: scroll;">
    <h1>Super Charger Review Submission</h1>
    <div class="form-group">
        <label for="name">Name:</label>
        <input class="form-control" id="name" type="text" required>
    </div>
    <div class="form-group">
        <label for="email">Email:</label>
        <input class="form-control" id="email" type="email" required>
    </div>
    <div class="form-group">
        <label for="chargerType">Charger Type:</label>
        <select class="form-control selectpicker" id="chargerType">
            <option value="0">Supercharger</option>
            <option value="1">Destination Charger</option>
        </select>
    </div>
    <div class="form-group">
        <label for="location">Search Chargers:</label>
        <input class="form-control" id="location" type="text" required>
    </div>
    <div class="form-group">
        <label for="chargers">Charger (this will be populated with results from the above search):</label>
        <select class="form-control selectpicker" id="chargers">

        </select>
    </div>
    <div class="form-group">
        <label for="link">Youtube Link to Review:</label>
        <input class="form-control" id="link" type="text" required>
    </div>
    <div class="form-group">
        <label for="rating">Rating out of 10:</label>
        <input class="form-control" id="rating" type="number" min="1" max="10" step="1" required>
    </div>
    <button type="button" class="form-control btn-primary" id="submitButton">Submit Review</button>
</div>
</body>
</html>